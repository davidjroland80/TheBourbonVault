<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bourbon Tasting Tracker</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#d97706;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; background:linear-gradient(180deg,#071024 0%, #07192a 100%); color:#e6eef6; padding:28px}
    .app{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}

    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=date],input[type=number],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px}
    textarea{min-height:96px;resize:vertical}
    .row{display:flex;gap:8px}
    .btn{background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:#071024;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:12px}
    .item{display:flex;gap:14px;align-items:flex-start;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.02)}
    .meta{font-size:12px;color:var(--muted)}
    .stars{display:inline-block}
    .small{font-size:13px;color:var(--muted)}
    .actions{margin-left:auto;display:flex;gap:8px}
    .pill{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .empty{padding:26px;text-align:center;color:var(--muted);border-radius:10px;border:1px dashed rgba(255,255,255,0.04)}
    .thumb{width:96px;height:72px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.04);}
    .form-row{display:flex;gap:8px}
    .muted-note{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='44' height='44'><rect rx='8' ry='8' width='44' height='44' fill='%23D97706'/><text x='50%' y='58%' font-size='22' text-anchor='middle' fill='white' font-family='Arial' font-weight='700'>B</text></svg>" alt="logo" style="width:44px;height:44px;border-radius:8px;"/>
      <div>
        <h1>Bourbon Tasting Tracker</h1>
        <div class="small">Save tasting notes, proofs, ratings — live with Firebase (Storage + Firestore)</div>
      </div>
    </header>

    <div class="grid">
      <aside>
        <div class="card">
          <form id="reviewForm">
            <input type="hidden" id="reviewId" />
            <label for="distillery">Distillery / Brand</label>
            <input id="distillery" placeholder="e.g. Buffalo Trace" required />

            <label for="bottle">Bottle / Expression</label>
            <input id="bottle" placeholder="e.g. Single Oak Project #10" />

            <label for="proof">Proof</label>
            <input id="proof" type="number" placeholder="e.g. 101" />

            <label for="date">Tasting date</label>
            <input id="date" type="date" />

            <label for="rating">Rating (1–10, allow decimals)</label>
            <input id="rating" type="number" min="1" max="10" step="0.1" placeholder="e.g. 8.5" />

            <label for="notes">Tasting notes</label>
            <textarea id="notes" placeholder="Nose:... Palate:... Finish:..."></textarea>

            <label for="imageInput">Bottle photo (optional)</label>
            <input id="imageInput" type="file" accept="image/*" />
            <div class="muted-note">Tip: images are uploaded to your Firebase Storage. Keep file sizes reasonable.</div>
            <div style="display:flex;gap:8px;margin-top:12px">
              <button type="submit" class="btn">Save review</button>
              <button type="button" id="clearBtn" class="btn ghost">Clear</button>
            </div>
          </form>

          <hr style="margin:16px 0;border:none;border-top:1px solid rgba(255,255,255,0.02)" />
          <div class="small">Sync status: <span id="status">—</span></div>
          <div class="small" style="margin-top:6px">User ID: <span id="uid">—</span></div>
        </div>
      </aside>

      <main>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div style="display:flex;gap:8px;align-items:center">
              <input id="search" placeholder="Filter by distillery, bottle, or notes" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);min-width:260px;color:inherit" />
              <select id="sort">
                <option value="dateDesc">Newest first</option>
                <option value="dateAsc">Oldest first</option>
                <option value="ratingDesc">Highest Score</option>
                <option value="ratingAsc">Lowest Score</option>
              </select>
            </div>
            <div class="pill">Total: <span id="count">0</span></div>
          </div>

          <div id="list" class="list">
            <div class="empty">No reviews yet — add one on the left.</div>
          </div>
        </div>

        <footer>
          Deployed via GitHub Pages — replace firebaseConfig, enable Firestore & Storage, and secure rules for production.
        </footer>
      <section class="card" style="margin-top:20px">
  <h2 style="margin-top:0">Ratings Overview</h2>
  <canvas id="ratingChart" height="120"></canvas>
</section>
</main>
    </div>
  </div>

  <!-- Firebase v9 modular CDN -->
  <script type="module">
    // ---------- Firebase Imports ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ---------- Firebase Config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAWhivu2HR_6epguOnwxvu7Nfsu1OYKESA",
      authDomain: "bourbon-vault.firebaseapp.com",
      databaseURL: "https://bourbon-vault-default-rtdb.firebaseio.com",
      projectId: "bourbon-vault",
      storageBucket: "bourbon-vault.firebasestorage.app",
      messagingSenderId: "1013190214804",
      appId: "1:1013190214804:web:594665cae3a79a3451a081"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ---------- Auth UI ----------
    const signInBtn = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const userDisplay = document.getElementById("userDisplay");

    signInBtn.onclick = () => signInWithPopup(auth, provider);
    signOutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        signInBtn.style.display = "none";
        signOutBtn.style.display = "inline-block";
        userDisplay.textContent = `Signed in as ${user.displayName}`;
      } else {
        signInBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        userDisplay.textContent = "";
      }
    });

    // ---------- Firestore Collection ----------
    const reviewsCol = collection(db, "reviews");

    // ---------- DOM Elements ----------
    const reviewForm = document.getElementById('reviewForm');
    const reviewsList = document.getElementById('reviewsList');

    // ---------- Submit Review (Login Required) ----------
    reviewForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const user = auth.currentUser;
      if (!user) {
        alert('You must be logged in to submit a review.');
        return;
      }

      const formData = new FormData(reviewForm);
      const imageFile = formData.get('photo');
      let imageUrl = null;
      let imagePath = null;

      if (imageFile && imageFile.size > 0) {
        imagePath = `images/${user.uid}/${Date.now()}_${imageFile.name}`;
        const storageRef = ref(storage, imagePath);
        await uploadBytes(storageRef, imageFile);
        imageUrl = await getDownloadURL(storageRef);
      }

      await addDoc(reviewsCol, {
        userId: user.uid,
        name: formData.get('name'),
        distillery: formData.get('distillery'),
        rating: parseFloat(formData.get('rating')),
        notes: formData.get('notes'),
        imageUrl,
        imagePath,
        createdAt: serverTimestamp(),
      });

      reviewForm.reset();
    });

    // ---------- Render Reviews (Anyone Can View) ----------
    onSnapshot(reviewsCol, (snapshot) => {
      reviewsList.innerHTML = '';
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const item = document.createElement('div');
        item.classList.add('review-item');

        item.innerHTML = `
          <h3>${data.name}</h3>
          <p><strong>Distillery:</strong> ${data.distillery}</p>
          <p><strong>Rating:</strong> ${data.rating}</p>
          <p>${data.notes}</p>
          ${data.imageUrl ? `<img src="${data.imageUrl}" class="thumb" />` : '<div class="placeholder">No Image</div>'}
        `;

        reviewsList.appendChild(item);
      });
    });

  </script>
  <!-- Authentication UI -->
  <div id="auth-section" style="margin:20px 0;">
    <button id="signInBtn">Sign In with Google</button>
    <button id="signOutBtn" style="display:none;">Sign Out</button>
    <span id="userDisplay" style="margin-left:10px;"></span>
  </div>

  <script type="module">
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const signInBtn = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const userDisplay = document.getElementById("userDisplay");

    signInBtn.onclick = () => signInWithPopup(auth, provider);
    signOutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        signInBtn.style.display = "none";
        signOutBtn.style.display = "inline-block";
        userDisplay.textContent = `Signed in as ${user.displayName}`;
      } else {
        signInBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        userDisplay.textContent = "";
      }
    });
  </script>

  <!-- Firestore & Storage Security Rules (For Firebase Console) -->
  <!--
  Firestore Rules:
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /reviews/{reviewId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.uid;
      }
    }
  }

  Storage Rules:
  rules_version = '2';
  service firebase.storage {
    match /b/{bucket}/o {
      match /images/{userId}/{fileId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
  -->

</body>
</html>
